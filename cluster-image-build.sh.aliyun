#!/bin/bash
set -e

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
SRC_DIR=$(dirname $SCRIPT_DIR)

VERSION="0.0.1"
AY_REGION=${AY_REGION:-"eu-central-1"} 
AY_PREFIX=${AY_PREFIX:-"labay"}
AY_BASE_DOMAIN=${AY_BASE_DOMAIN:-"alicloud-dev.devcluster.openshift.com"}

# AY_CLUSTER_NAME=${AY_CLUSTER_NAME:-"$AY_PREFIX$(date +%Y%m%d%H%M)"}
AY_CLUSTER_NAME="$AY_PREFIX$(date +%Y%m%d%H%M%S)"
export AY_CLUSTER_NAME
AY_BUCKET_NAME=${AY_BUCKET_NAME:-"$AY_CLUSTER_NAME-bucket"}
export AY_BUCKET_NAME

echo "=== OpenShift LabAY Install Script $VERSION ==="
echo "pwd: $(pwd)"
echo "whoami: $(whoami)"
echo "cluster: $AY_CLUSTER_NAME"
echo "region: $AY_REGION"
echo "bucket: $AY_BUCKET_NAME"


echo "Installing openshift clients"

TMP_DIR="$SCRIPT_DIR/.tmp"
INSTALL_DIR="$SCRIPT_DIR/.openshift"

mkdir -p $TMP_DIR
cd $TMP_DIR

REPO_DIR="$SCRIPT_DIR"
cd $REPO_DIR


# OpenShift CLI
if ! command -v oc &> /dev/null
then
    mkdir -p "$TMP_DIR/oc" 
    wget -nv -O "$TMP_DIR/oc/openshift-client-linux.tar.gz" "https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/latest/openshift-client-linux.tar.gz" 
    tar zxvf "$TMP_DIR/oc/openshift-client-linux.tar.gz" -C "$TMP_DIR/oc" 
    sudo mv "$TMP_DIR/oc/oc" "/usr/local/bin/" 
    sudo mv "$TMP_DIR/oc/kubectl" "/usr/local/bin/" 
    rm "$TMP_DIR/oc/openshift-client-linux.tar.gz" 
    oc version client
fi

mkdir -p "$INSTALL_DIR"

echo "Verify OSS Bucket"
if ! aliyun oss ls | grep -q $AY_BUCKET_NAME
then
    echo "Create alibaba oss bucket"
    aliyun oss mb oss://$AY_BUCKET_NAME --region $AY_REGION
fi

## Assisted Installer Section ##
export AY_OCP_VERSION=${AY_OCP_VERSION:-"4.15.14"}
export AY_MANIFESTS_DIR="$SRC_DIR/.ai/manifests"
mkdir -p "$AY_MANIFESTS_DIR"

AY_SSH_KEY=$(cat ~/.ssh/id_rsa.pub)

aicli create cluster "$AY_CLUSTER_NAME" \
    -P openshift_version="$AY_OCP_VERSION" \
    -P base_dns_domain="$AY_BASE_DOMAIN" \
    -P ssh_public_key="$AY_SSH_KEY"

sleep 10 

# check if iso does not exist
export AY_ISO_FILE="${AY_CLUSTER_NAME}.iso"

if ! aliyun oss ls | grep -q $AY_ISO_FILE
then
    echo "Download iso from assisted installer"
    aicli download iso "$AY_CLUSTER_NAME"
    qemu-img convert -O qcow2 ${AY_CLUSTER_NAME}.iso ${AY_CLUSTER_NAME}.qcow2
fi


export AY_OBJECT_NAME="${AY_CLUSTER_NAME}.qcow2"
# du -sh --block-size=M labay202404191718.qcow2
export AY_OBJECT_SIZE=$(stat --format="%s" ${AY_OBJECT_NAME} | awk '{print int(($1/1024**3)+5)}')
echo "AY_OBJECT_SIZE=$AY_OBJECT_SIZE"

echo "Upload qcow2 to alibaba oss"
aliyun oss cp $AY_OBJECT_NAME oss://$AY_BUCKET_NAME/

echo "Verify image upload"
export AY_QCOW_URL="oss://$AY_BUCKET_NAME/$AY_OBJECT_NAME"
aliyun oss ls $AY_QCOW_URL

#create alibaba custom image from qcow 
echo "Create alibaba custom image from qcow"
export AY_IMAGE_NAME="${AY_CLUSTER_NAME}-image"

# https://www.alibabacloud.com/help/en/ecs/developer-reference/api-ecs-2014-05-26-importimage?spm=a2c63.p38356.0.0.7c4a2122Z0bC7W
aliyun ecs ImportImage \
    --RegionId $AY_REGION \
    --ImageName $AY_IMAGE_NAME \
    --Architecture x86_64 \
    --Platform CoreOS \
    --Description "OpenShift Image for ${AY_CLUSTER_NAME}" \
    --DiskDeviceMapping.1.OSSBucket $AY_BUCKET_NAME \
    --DiskDeviceMapping.1.OSSObject $AY_OBJECT_NAME \
    --DiskDeviceMapping.1.DiskImageSize $AY_OBJECT_SIZE \
    | tee .import-image.log.json

export AY_IMAGE_ID=$(jq -r '.ImageId' .import-image.log.json)
echo "# Container Creation Settings"
echo "export AY_BASE_DOMAIN=$AY_BASE_DOMAIN"
echo "export AY_OCP_VERSION=$AY_OCP_VERSION"
echo "export AY_IMAGE_ID=$AY_IMAGE_ID"
echo "export AY_CLUSTER_NAME=$AY_CLUSTER_NAME"

echo "=== OpenShift LabAY Image Generation Script Done $VERSION ==="